# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is an NPM package that logs server-side Request/Response objects as HAR (HTTP Archive) entries for debugging and comparison with client HAR exports. It supports both JSONL (line-delimited JSON) and .har file formats.

**Key characteristics:**
- ESM-only package (`"type": "module"`)
- TypeScript library with type definitions
- Runtime-agnostic design (Node.js and edge runtimes like Cloudflare Workers)
- Single-file architecture ([src/index.ts](src/index.ts))

## Commands

### Build & Development
```bash
pnpm build              # Compile TypeScript to dist/
pnpm clean              # Remove dist/ folder
pnpm test               # Run tests with Vitest
```

### Testing
```bash
pnpm test               # Run all tests with Vitest (reporter=dot)
pnpm simple-test        # Run simple-test.mjs with node --experimental-fetch
```

### Package Management
```bash
pnpm prepare            # Pre-install hook (runs build)
pnpm prepublishOnly     # Pre-publish hook (runs build)
```

**Note:** This project uses `pnpm` as the package manager (v10.18.1).

## Architecture

### Core Module Structure

The entire implementation is in [src/index.ts](src/index.ts) (~263 lines). It exports:

1. **Main function:** `logHarEntry(request, response?, opts?)` - Logs a HAR entry
2. **Types:** `LogOptions`, `NameValue`

### How It Works

1. **Request/Response Cloning:** Safely clones Request/Response objects to read bodies without consuming the original streams
2. **Body Detection:** Automatically detects text vs binary content based on MIME type (`isProbablyText()`)
3. **Dual Output:** Can write to both JSONL (append mode) and .har file (read-modify-write)
4. **Runtime Detection:** Uses `isNodeRuntime()` to handle Node.js vs edge runtime differences

### Key Functions

- `headersToArray()` - Converts Headers object or Record to HAR-compatible name/value array
- `queryToArray()` - Extracts query parameters from URL
- `isProbablyText()` - Determines if content-type is text-based (JSON, XML, etc.)
- `maybeTruncate()` - Limits body size to `maxBodyChars` (default: 100k chars)

### Runtime Handling

- **Node.js:** Writes to filesystem using fs promises
- **Edge runtimes:** Falls back to console.log when filesystem is unavailable

### HAR File Format

When `harFilePath` is specified, the library:
1. Reads existing .har file (if present)
2. Appends new entry to `log.entries[]`
3. Writes back complete HAR object with proper structure:
   ```json
   {
     "log": {
       "version": "1.2",
       "creator": { "name": "...", "version": "..." },
       "entries": [...]
     }
   }
   ```

## Testing Strategy

Tests are in [test/harLogger.test.ts](test/harLogger.test.ts) using Vitest. Each test:
1. Creates a temporary directory (`./tmp-tests`)
2. Runs the logging function
3. Reads and validates the output files
4. Cleans up in `afterAll()`

**Test coverage includes:**
- Basic JSONL logging
- Multiple entries in .har files
- Response body logging (with `includeResponse: true`)
- Binary request body handling (base64 encoding)

## Development Notes

### When Modifying the Logger

- The library must support both Node.js and edge runtimes (Cloudflare Workers, Vercel Edge, etc.)
- Always use `promisify()` for Node.js fs operations
- Clone Request/Response objects before reading bodies to avoid consuming streams
- Maintain HAR 1.2 spec compliance

### Security Considerations

The README suggests implementing header redaction for sensitive data:
- Authorization headers
- Cookies

Example pattern (not implemented by default):
```typescript
function redactHeaderArray(arr: NameValue[]) {
  return arr.map(h => {
    if (h.name.toLowerCase() === "authorization" || h.name.toLowerCase() === "cookie") {
      return { name: h.name, value: "[REDACTED]" };
    }
    return h;
  });
}
```

### Optional Enhancements

The README mentions:
1. **Request filtering:** Add `filter?: (req: Request) => boolean` to `LogOptions`
2. **Bundling:** Consider using esbuild/Rollup for single-file distribution

## Build Output

- **[dist/index.js](dist/index.js)** - Compiled ESM JavaScript
- **[dist/index.d.ts](dist/index.d.ts)** - TypeScript type definitions

Both files are generated by `tsc` and published to NPM (see `"files": ["dist"]` in package.json).
